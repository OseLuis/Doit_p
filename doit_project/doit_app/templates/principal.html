{% extends "base.html" %}
{% load static %}

{% block title %}DOIT | Principal cliente{% endblock %} {# T√≠tulo para la pesta√±a del navegador #}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/principal.css' %}">
<link rel="stylesheet" href="{% static 'css/modperf_cliente.css' %}">
{% endblock %}

{% block content %}

    <div class="header-container">
        <div class="perfil-header">
            <div class="perfil-foto-container">
                <img src="{% static 'images/fotoperfilMuj.jpg' %}" alt="Foto de perfil de Juliana" class="perfil-foto">
                <p class="perfil-nombre">
                    {# L√≥gica mejorada para mostrar el nombre del usuario logueado #}
                    {% if user.is_authenticated %}
                        {% if user.first_name and user.last_name %}
                            {{ user.first_name }} {{ user.last_name }}
                        {% elif user.first_name %}
                            {{ user.first_name }}
                        {% elif user.username %} {# Si no hay nombre ni apellido, usa el nombre de usuario #}
                            {{ user.username }}
                        {% else %} {# Fallback para un caso muy improbable #}
                            Usuario desconocido
                        {% endif %}
                    {% else %}
                        Invitado {# Esto no deber√≠a verse, ya que la p√°gina est√° protegida #}
                    {% endif %}
                </p>
            </div>
            <div>
                {# Aseg√∫rate de que 'perfil' sea el nombre de la URL para la vista de edici√≥n #}
                <a href="{% url 'perfil' %}">
                    <button class="modificar-perfil-btn">Modificar perfil</button>
                </a>
            </div>
        </div>

        <div class="banner-bienvenida">
            <div class="contenido-banner">
                <h1>üëã ¬°Bienvenid@
                    {# Tambi√©n muestra el nombre (o username) en el saludo #}
                    {% if user.is_authenticated %}
                        {% if user.first_name %}
                            {{ user.first_name }}
                        {% elif user.username %}
                            {{ user.username }}
                        {% endif %}
                    {% endif %}
                    a
                    <a href="{% url 'home' %}">
                        <img src="{% static 'images/Doit_logo.png' %}" alt="Logo Doit" width="80">
                    </a>
                </h1>
                <input type="text" placeholder="Escribe el nombre del experto aqu√≠...." style="margin-left: 60px;">
            </div>
        </div>
    </div>

    <a href="{% url 'busc_experto' %}" class="boton-experto">Buscar experto</a>

<section class="seccion-servicios">
    <div class="tarjeta-servicio">
        <h3>Reserva tu servicio</h3>

        <div class="grupo-formulario">
            <label for="categoria">Selecciona una categor√≠a:</label>
            <select id="categoria">
                <option selected disabled>-- Elige una categor√≠a --</option>
                {% for categoria in categorias %}
                    <option value="{{ categoria.Nombre }}">{{ categoria.Nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="grupo-formulario">
            <label for="servicio">Selecciona un servicio:</label>
            <select id="servicio" disabled>
                <option selected>-- Elige un servicio --</option>
            </select>
        </div>

        <a id="reservarLink" href="{% url 'reserva' %}">
            <button id="reservarBtn" type="button" disabled>Reservar</button>
        </a>
    </div>
</section>

<script>
    const categoriaSelect = document.getElementById('categoria');
    const servicioSelect = document.getElementById('servicio');
    const reservarBtn = document.getElementById('reservarBtn');
    const reservarLink = document.getElementById('reservarLink');

    // Servicios agrupados por categor√≠a, cada uno con id y nombre
    const serviciosPorCategoria = {
        {% for categoria, servicios in servicios_por_categoria.items %}
            "{{ categoria }}": [
                {% for serv in servicios %}
                    {"id": "{{ serv.id }}", "nombre": "{{ serv.NombreServicio }}"},
                {% endfor %}
            ],
        {% endfor %}
    };

    categoriaSelect.addEventListener('change', () => {
        const seleccionada = categoriaSelect.value;
        servicioSelect.innerHTML = '';
        if(serviciosPorCategoria[seleccionada]) {
            serviciosPorCategoria[seleccionada].forEach(serv => {
                const option = document.createElement('option');
                option.value = serv.id;       // id del servicio
                option.textContent = serv.nombre;  // nombre visible
                servicioSelect.appendChild(option);
            });
            servicioSelect.disabled = false;
            reservarBtn.disabled = true;
            reservarLink.href = "{% url 'reserva' %}"; // resetear href
        }
    });

    servicioSelect.addEventListener('change', () => {
        reservarBtn.disabled = false;
        const servicioSeleccionado = servicioSelect.value;
        reservarLink.href = "{% url 'reserva' %}?servicio_id=" + encodeURIComponent(servicioSeleccionado);
    });
</script>

<h2>Servicios:</h2>

{% if messages %}
    {% for message in messages %}
    <div style="
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding: 15px 20px;
        background-color:rgb(62, 151, 163);
        color:rgb(243, 243, 248);
        border-left: 6px solid #ffecb5;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        box-shadow: 10px 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
    ">
        <div class="custom-spinner"></div>
            <div style="white-space: pre-line;">
        {{ message }}
        </div>
    </div>
    {% endfor %}
{% endif %}

<style>
.custom-spinner {
    width: 20px;
    height: 20px;
    border: 3px solid #ffeeba;
    border-top: 3px solid #ffc107;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}
</style>
        <div class="servicios">
            <article class="servicio">
            <h2>CUIDADO PERSONAL</h2>
            <img src="{% static 'images/20.jpg' %}" alt="Foto 1">
            <p>Ofrecemos contactos con expertos en proporcionar momentos de relajaci√≥n, realzar la belleza natural y ayudar a enfrentar cada d√≠a con m√°s confianza.</p>
        </article>
            <article class="servicio">
            <h2>CUIDADO HOGAR</h2>
            <img src="{% static 'images/21.png' %}" alt="Foto 2">
            <p>Doit te conecta con un equipo de profesionales capacitados que trabaja con dedicaci√≥n, utilizando t√©cnicas innovadoras, asegur√°ndose que cada rinc√≥n brille y transmita armon√≠a.</p>
        </article>
        <article class="servicio">
            <h2>LOCATIVOS</h2>
            <img src="{% static 'images/22.png' %}" alt="Foto 3">
            <p>Contactamos profesionales en servicios locativos para cubrir tus necesidades de mantenimiento, reparaci√≥n y adecuaci√≥n del hogar.</p>
        </article>
        </div>
    </section>
    <div class="servicios-populares">
        <div class="servicios-mas-solicitados">
            <h2>‚≠ê Servicios m√°s solicitados</h2>
                <div class="servicios-grid">
            <div class="servicio-cuadro">
                <img src="{% static 'images/22.png' %}" alt="Electricista">
                <h3>Pintor</h3>
            </div>
            <div class="servicio-cuadro">
                <img src="{% static 'images/ex5.png' %}" alt="Plomer√≠a">
                <h3>Plomer√≠a</h3>
            </div>
            <div class="servicio-cuadro">
                <img src="{% static 'images/21.png' %}" alt="Aseo">
                <h3>Aseo</h3>
            </div>
        </div>
    </div>
{% endblock content %}